# Cluster wide secret store. For now, this is simpler to manage than a secret
# store in each namespace, because this requires the infistical credentials to
# be created, and the credentials are only provisioned in the infisticaleso
# namespace.
#
# To avoid pods being able to read all secrets, multiple cluster secret stores
# can be created mounting different paths in infistical.
---
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: infisical-secret-store
  namespace: infisticaleso
spec:
  provider:
    infisical:
      hostAPI: https://eu.infisical.com
      auth:
        universalAuthCredentials:
          clientId:
            key: clientId
            namespace: infisticaleso
            name: infistical-auth-credentials
          clientSecret:
            key: clientSecret
            namespace: infisticaleso
            name: infistical-auth-credentials
      secretsScope:
        projectSlug: kubernetes-3-v-pr
        # "dev", "staging", "prod", etc.
        environmentSlug: prod
        # Optional (default: `/`).
        #
        # Secrets will only be retrieved from this path for `data` and `dataFrom` rules. When a
        # `data` `remoteRef` uses a path (e.g. `/foo/bar`), that reference will use an absolute
        # reference and disregard this default.
        #
        # If you need to prevent access to secrets outside of this path, rely on instead setting
        # Access Controls in Infisical.
        secretsPath: /
        # Optional (default: false).
        #
        # When recursive is enabled, secrets retrieved using `dataFrom` patterns will fetch all secrets recursive.
        recursive: false
        # optional
        expandSecretReferences: false
  conditions:
    - namespaceRegexes:
        - ".*" # For now allow all namespaces to create external secrets using this
---
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: lifebuddies-github-app
  namespace: infisticaleso
spec:
  provider:
    infisical:
      hostAPI: https://eu.infisical.com
      auth:
        universalAuthCredentials:
          clientId:
            key: clientId
            namespace: infisticaleso
            name: infistical-auth-credentials
          clientSecret:
            key: clientSecret
            namespace: infisticaleso
            name: infistical-auth-credentials
      secretsScope:
        projectSlug: kubernetes-3-v-pr
        # "dev", "staging", "prod", etc.
        environmentSlug: prod
        # Optional (default: `/`).
        #
        # Secrets will only be retrieved from this path for `data` and `dataFrom` rules. When a
        # `data` `remoteRef` uses a path (e.g. `/foo/bar`), that reference will use an absolute
        # reference and disregard this default.
        #
        # If you need to prevent access to secrets outside of this path, rely on instead setting
        # Access Controls in Infisical.
        secretsPath: /lifebuddies-github-app
        # Optional (default: false).
        #
        # When recursive is enabled, secrets retrieved using `dataFrom` patterns will fetch all secrets recursive.
        recursive: false
        # optional
        expandSecretReferences: false
  conditions:
    - namespaceRegexes:
        - ".*" # For now allow all namespaces to create external secrets using this
---
# Secret store for lifebuddies app.
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: lifebuddies
  namespace: infisticaleso
spec:
  provider:
    infisical:
      hostAPI: https://eu.infisical.com
      auth:
        universalAuthCredentials:
          clientId:
            key: clientId
            namespace: infisticaleso
            name: infistical-auth-credentials
          clientSecret:
            key: clientSecret
            namespace: infisticaleso
            name: infistical-auth-credentials
      secretsScope:
        projectSlug: kubernetes-3-v-pr
        # "dev", "staging", "prod", etc.
        environmentSlug: prod
        # Optional (default: `/`).
        #
        # Secrets will only be retrieved from this path for `data` and `dataFrom` rules. When a
        # `data` `remoteRef` uses a path (e.g. `/foo/bar`), that reference will use an absolute
        # reference and disregard this default.
        #
        # If you need to prevent access to secrets outside of this path, rely on instead setting
        # Access Controls in Infisical.
        secretsPath: /lifebuddies
        # Optional (default: false).
        #
        # When recursive is enabled, secrets retrieved using `dataFrom` patterns will fetch all secrets recursive.
        recursive: false
        # optional
        expandSecretReferences: false
  conditions:
    - namespaceRegexes:
        - ".*" # For now allow all namespaces to create external secrets using this
